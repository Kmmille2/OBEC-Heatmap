<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OBEC Coverage Map</title>
    <style>
        html,
        body,
        #map {
            margin: 0;
            height: 100%;
            width: 100%;
        }
        .mapboxgl-ctrl-top-right {
            margin: 10px;
        }
    </style>

    <link href='https://api.mapbox.com/mapbox-gl-js/v3.11.1/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.11.1/mapbox-gl.js'></script>

</head>

<body>

    <div id="map"></div>

    <script>
        /* Wix / CSP worker fix - Point to LOCAL worker file */
        mapboxgl.workerUrl = 'mapbox-gl-csp-worker.js';
        mapboxgl.workerCount = 2;

        /* Public token */
        mapboxgl.accessToken =
            'pk.eyJ1Ijoia3lsZS1taWxsZXIiLCJhIjoiY21hNWVya2RzMGlycjJpbzl4OW1kaGtodiJ9.u5I5rSYZSB1pqdX7rjudQw';

        /* Heatmap colours */
        const heatGradient = [
            'interpolate', ['linear'], ['heatmap-density'],
            0, 'rgba(167,154,248,0)',
            0.3, 'rgba(167,154,248,0.5)',
            0.6, 'rgba(147,41,19,0.7)',
            1, 'rgba(147,41,19,0.9)'
        ];
        const pinColor = '#932913';
        const circleClr = 'rgba(167,154,248,1)'; // Use full opacity in base color, control via layer opacity

        /* Service hubs - Radii are now defined by multipliers below */
        const points = [
            { n: 'East Windsor NJ', lat: 40.267, lng: -74.525, r: 50, w: 1 }, // r is base radius in miles (50)
            { n: 'New Castle DE',   lat: 39.687, lng: -75.586, r: 50, w: 1 },
            { n: 'Wake Forest NC',  lat: 35.979, lng: -78.507, r: 50, w: 1 }
        ];

        // Convert points array to GeoJSON FeatureCollection for Mapbox sources
        const feat = {
            type: 'FeatureCollection',
            features: points.map(p => ({
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [p.lng, p.lat]
                },
                properties: {
                    weight: p.w
                }
            }))
        };

        /* Build the map */
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/standard',
            center: [-76.5, 38.5],
            zoom: 5,
            attributionControl: false
        });

        map.addControl(new mapboxgl.NavigationControl());

        map.on('load', () => {
            map.addSource('hubs', {
                type: 'geojson',
                data: feat
            });

            map.addLayer({
                id: 'heat',
                type: 'heatmap',
                source: 'hubs',
                maxzoom: 9,
                paint: {
                    'heatmap-weight': ['get', 'weight'],
                    'heatmap-color': heatGradient,
                    'heatmap-radius': 60,
                    'heatmap-opacity': 0.8
                }
            });

            points.forEach(p => {
                new mapboxgl.Marker({ color: pinColor })
                    .setLngLat([p.lng, p.lat])
                    .setPopup(new mapboxgl.Popup({ offset: 25 }).setText(p.n))
                    .addTo(map);

                // Add a separate source for each point's circles (using the same source for all layers of that point)
                map.addSource(p.n + '-c', {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [p.lng, p.lat]
                        }
                    }
                });

                // --- START: Layered Circles ---
                // Layers added later are drawn on top. Add outer (most transparent) first.

                // 1. Outer Circle (Largest radius, lowest opacity)
                map.addLayer({
                    id: p.n + '-cL-outer', // Unique ID
                    type: 'circle',
                    source: p.n + '-c', // Use the point's source
                    paint: {
                        'circle-radius': p.r * 1609.34 * 4, // 200 miles (50 * 4)
                        'circle-color': circleClr,
                        'circle-stroke-color': pinColor, // Optional: Maybe only stroke the outermost?
                        'circle-stroke-width': 1,        // Optional: Set to 0 for inner circles if desired
                        'circle-opacity': 0.30  // Low opacity
                    }
                });

                // 2. Middle Circle (Medium radius, medium opacity)
                map.addLayer({
                    id: p.n + '-cL-middle', // Unique ID
                    type: 'circle',
                    source: p.n + '-c',
                    paint: {
                        'circle-radius': p.r * 1609.34 * 2, // 100 miles (50 * 2)
                        'circle-color': circleClr,
                        'circle-stroke-width': 0, // No stroke for inner circles usually looks better
                        'circle-opacity': 0.55 // Medium opacity (higher than outer)
                    }
                });

                // 3. Inner Circle (Base radius, highest opacity)
                map.addLayer({
                    id: p.n + '-cL-inner', // Unique ID
                    type: 'circle',
                    source: p.n + '-c',
                    paint: {
                        'circle-radius': p.r * 1609.34 * 1, // 50 miles (base radius)
                        'circle-color': circleClr,
                        'circle-stroke-width': 0, // No stroke
                        'circle-opacity': 0.80 // High opacity (higher than middle)
                    }
                });
                // --- END: Layered Circles ---

            });
        });

    </script>

</body>

</html>
